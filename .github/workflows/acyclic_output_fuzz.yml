name: Acyclic Output Fuzz

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
  pull_request:
    types: [labeled]

permissions: {}

jobs:
  acyclic-output-fuzz:
    if: github.event_name != 'pull_request' || github.event.label.name == 'run-tests'
    permissions:
      contents: read
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          submodules: recursive
          persist-credentials: false

      - name: Setup Rust
        uses: oxc-project/setup-rust@c8224157c0bf235aabc633e8cd50d344f087a7de # v1.0.12
        with:
          cache-key: debug-build

      - name: Run acyclic output fuzz test
        id: fuzz
        continue-on-error: true
        env:
          PROPTEST_CASES: 5000
        run: |
          set -o pipefail
          timeout 900 cargo test --manifest-path acyclic_output_fuzz/Cargo.toml -- --nocapture 2>&1 | tee acyclic_output_fuzz.log

      - name: Upload fuzz logs
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: acyclic-output-fuzz-log-${{ github.run_id }}
          path: acyclic_output_fuzz.log
          if-no-files-found: ignore

      - name: Mark workflow as failed
        if: steps.fuzz.outcome == 'failure'
        run: exit 1

  update-tracking-issue:
    needs: acyclic-output-fuzz
    if: always() && needs.acyclic-output-fuzz.result == 'failure' && github.event_name != 'pull_request'
    permissions:
      issues: write
    runs-on: ubuntu-latest
    steps:
      - name: Download fuzz logs
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: acyclic-output-fuzz-log-${{ github.run_id }}

      - name: Create or update tracking issue
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('node:fs');

            const { owner, repo } = context.repo;
            const title = 'Daily acyclic output fuzz failure';
            const label = 'zarara-fuzz';
            const nowUtc = new Date().toISOString();
            const runUrl = `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`;
            const sha = context.sha;
            const log = fs.existsSync('acyclic_output_fuzz.log')
              ? fs.readFileSync('acyclic_output_fuzz.log', 'utf8')
              : '';

            const failureMarkdownMatches = [
              ...log.matchAll(/## Failed Seed[\s\S]*?### Generate Fixture\s*```bash[\s\S]*?```/g),
            ];
            const failureMarkdown = failureMarkdownMatches.length > 0
              ? failureMarkdownMatches.at(-1)[0].trim()
              : 'Failed to parse markdown failure output from `acyclic_output_fuzz.log`.';

            async function ensureLabelExists() {
              try {
                await github.rest.issues.getLabel({ owner, repo, name: label });
              } catch (error) {
                if (error.status !== 404) {
                  throw error;
                }
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: label,
                  color: 'd73a4a',
                  description: 'Daily acyclic output fuzz failures',
                });
              }
            }

            await ensureLabelExists();

            const { data: openIssues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: label,
              per_page: 100,
            });

            const existing = openIssues.find((issue) => issue.title === title);
            const body = [
              '### Latest failure',
              `- Run: ${runUrl}`,
              `- SHA: \`${sha}\``,
              `- UTC: ${nowUtc}`,
              '',
              failureMarkdown,
            ].join('\n');

            if (existing) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: existing.number,
                body,
              });
            } else {
              const created = await github.rest.issues.create({
                owner,
                repo,
                title,
                labels: [label],
                body: [
                  'Daily acyclic-output fuzz guard failed.',
                  '',
                  'This issue stays open until manually closed.',
                ].join('\n'),
              });

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: created.data.number,
                body,
              });
            }
